name: Full Pipeline - Note/Blog/SNS

on:
  schedule:
    # 毎週月曜日 JST 9:00 (UTC 0:00) に全パイプライン実行
    - cron: '0 0 * * 1'
  workflow_dispatch:  # 手動実行も可能

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  # ===== Job 1: ブログ記事生成 =====
  generate-blog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install google-generativeai markdown
      - name: Generate Blog Article
        run: python blog/scripts/generate_article.py
      - name: Commit Blog
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add blog/
          git diff --cached --quiet || git commit -m "Auto: new blog article [$(date +%Y-%m-%d)]"

  # ===== Job 2: note記事生成 =====
  generate-note:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install google-generativeai
      - name: Generate Note Article
        run: python sns/note_generator.py --auto
      - name: Commit Note Draft
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add content/
          git diff --cached --quiet || git commit -m "Auto: new note draft [$(date +%Y-%m-%d)]"

  # ===== Job 3: X コンテンツ生成 =====
  generate-x-content:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - run: pip install google-generativeai
      - name: Generate X Content
        run: python sns/x_engagement_content.py --generate 7
      - name: Commit X Queue
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add sns/
          git diff --cached --quiet || git commit -m "Auto: x content queue [$(date +%Y-%m-%d)]"

  # ===== Job 4: 分析レポート =====
  analytics:
    runs-on: ubuntu-latest
    needs: [generate-blog, generate-note, generate-x-content]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # 最新のコミットを取得
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Generate Analytics Dashboard
        run: python sns/analytics_dashboard.py --mock
      - name: Push All Changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git pull --rebase
          git add -A
          git diff --cached --quiet || git commit -m "Auto: weekly pipeline complete [$(date +%Y-%m-%d)]"
          git push
